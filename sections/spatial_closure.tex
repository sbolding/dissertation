
\section{Spatial Closure based on the HO Solution}
\label{sec:spat_clos}

This sections describes an alternative spatial closure to the LO equations based on 
a parametric relation from the HO solution. In addition to estimating the angular
consistency terms, the HO intensity estimates a relation between volume and face-averaged
intensities to eliminate the remaining unknowns from the equations.  In the remainder of
this section, we will motivate the HO spatial closure by manipulating a half-range balance
equations to form a single unknown for each cell and half range.  We will then discuss
the forms of HO spatial closures investigated, based on modifications to standard spatial closures.

\subsection{Motivation}

A half-range balance equation for $\mu>0$ is formed by adding the
exact $L$ and
$R$ radiation moment equations given by
Eq.~\eqref{eq:exact_lmomp}~and~\eqref{eq:exact_rmomp}, i.e.,
\begin{equation}\label{eq:hr_bal}
    \mu^+_{i+1/2}\phi_{i+1/2}^+ - \mu^+_{i-1/2}\phi_{i-1/2}^+ +
    {\sigma_{a,i}h_i} \phi_i^+ = \frac{h_i}{2} q_i,
\end{equation}
where $q_i$ represents the cell-averaged emission source.  In the HOLO algorithm, after
estimating the consistency terms $\mu_{i\pm1/2}^+$ upwinding the inflow term
$\phi_{i-1/2}^+$, an additional equation is needed to eliminate the outflow $\phi_{i+1/2}^+$ to produce an
equation for a single unknown $\phi_{i}^+$.  Standard spatial discretizations techniques
use a fixed approximation for all cells to eliminate the outflow in terms of other
unknowns.  Alternatively, the HO solution can be used to estimate a parametric relation
between the other unknowns and the outflow, i.e.,
\begin{equation}\label{eq:ho_clos}
    \phi_{i+1/2}^+ = f(\gamma^{+,HO}_i, \phi_i^+, \phi_{x,i}^+, \phi_{i-1/2}^+),
\end{equation}
where $\gamma^{HO,+}_i$ is a local constant to be estimated with the HO solution and $f$ is some
function of some number of the input
variables.  The ECMC solution can provide all of the unknowns in the above equation, so
the value of $\gamma^{HO}_i$ can be determined directly. 

If the problem were linear, or the nonlinear problem was fully converged,
then application of this closure can ensure that the HO and LO equations produce the same
moments, preserving the HO accuracy.  To produce the
same moments, the HO solution must also satisfy the local balance equation, e.g.,
Eq.~\eqref{eq:hr_bal}.  Then the LO equations and HO equations must have the same moments
to satisfy both Eq.~\eqref{eq:ho_clos} and Eq.~\eqref{eq:hr_bal}, upon nonlinear
convergence of the outer HOLO iterations. If any higher moments are introduced through the spatial closure,
then the HO solution must also satisfy the corresponding balance equations that the LO
equations do.  For example, both the LO and HO equation must satisfy the
first moment equation in space if the closure is a function of the first moment.  

As TRT problems are non-linear (i.e., scattering or thermal emission are included in
$q$), the moments will only be preserved upon non-linear convergence of the source.  The
nonlinearity introduces the possibility for stability
issues, particularly with MC noise.  However, we have already consistently formed angular consistency terms, so the
the spatial closure should be more stable than introducing other terms, such as
in NDA methods~\cite{rmc,willert}. 





\subsection{Choice of Spatial Closure}
\label{sec:spat_clos_options}

We will
explore two different closure relations based on modifications to the standard LD closure: a scaled slope, i.e.,
\begin{equation}\label{eq:cl_slope1}
    \phi_{i\pm1/2}^\pm = \phi_i^+ \pm \gamma_i^{\pm} \phi_{x,i}^+
\end{equation}
and a scaled average
\begin{equation}\label{eq:cl_avg1}
    \phi_{i\pm1/2}^\pm = \gamma_i^{\pm} \phi_i^+ \pm \phi_{x,i}^+,
\end{equation}
where a value of $\gamma_i = 1$ produces the standard linear discontinuous expressions for
the extrapolated outflows.  Our LO system is formulated in terms of $L$ and $R$ moments, rather than the average and
slope.  Thus, Eq.~\eqref{eq:cl_slope1} and~\eqref{eq:cl_avg1} are expressed in terms of the $L$ and $R$
unknowns, using the relations given in App.~\ref{app:lo_mom_relations}.  In terms of these
moments, the scaled-slope closure is
\begin{align}\label{eq:cl_slope}
    \phi_{i+1/2}^+  &= \left(\frac{\ds 1 - 3 \gamma_i^+}{\ds 2 }  \right)
    \mom{\phi}_{L,i}^+ + \left(\frac{\ds 1 + 3 \gamma_i^+}{\ds 2 }  \right)
    \mom{\phi}_{R,i}^+ \\
    \phi_{i-1/2}^-  &= \left(\frac{\ds 1 + 3 \gamma_i^-}{\ds 2 }  \right)
    \mom{\phi}_{L,i}^- + \left(\frac{\ds 1 - 3 \gamma_i^-}{\ds 2 }  \right)
    \mom{\phi}_{R,i}^- 
\end{align}
and the scaled-average relation is
\begin{align}\label{eq:cl_avg}
    \phi_{i+1/2}^+  &= \left(\frac{\ds  \gamma_i^+ - 3}{\ds 2 }  \right)
    \mom{\phi}_{L,i}^+ + \left(\frac{\ds \gamma_i^+ + 3}{\ds 2 }  \right)
    \mom{\phi}_{R,i}^+ \\
    \phi_{i-1/2}^-  &= \left(\frac{\ds \gamma_i^- + 3}{\ds 2 }  \right)
    \mom{\phi}_{L,i}^- + \left(\frac{\ds \gamma_i^- - 3}{\ds 2 }  \right)
    \mom{\phi}_{R,i}^- .
\end{align}
REWRITE:  It is tempting to use a closure that is only a function of the average.  This
Although this can produce accuracy in smooth problems, it leads to a problem where the
slope of the source is accounted for almost entirely in the slope of the radiation and the
outflow is not forced to do anything intelligent. If you had scattering, this would become
very inaccurate.  This can be seen by looking at marshak wave and the slope equation, as
you come to equilibrium it causes problems.

The HO solution is used to estimate $\gamma_i$. The MC solution must be modified
to tally the MC estimated intensity on faces. For example, for $\mu>0$, the LO equations for
moments at $k+1$ use closure parameters evaluated at $k+1/2$ as
\begin{equation}
    \gamma_i^{+,HO,k+1/2} = \frac{\phi_{i+1/2}^{+,HO,k+1/2} -
    \phi_{i}^{+,HO,k+1/2}}{\phi_{x,i}^{+,HO,k+1/2}},
\end{equation}
for the scaled-slope closure.  For this closure, as the slope goes to zero this expression
becomes undefined.  In cells where the slope is $O(10^{-13} \psi_i)$, we use $\gamma_i=1$.
For the problems tested, no issues have occurred with this closure, even $\gamma$
can become very large for common, small values of $|\psi^x/\psi_i|$.  This is because in
such regions the solution is changing minimally anyways. 
The main benefit of the scaled-slope closure is it allows for values of $\gamma$ that are
equivalent to other closures, as discussed in App.~\ref{app:lo_mom_relations}:
$\gamma_i=0$ produces a step closure~\cite{larsen_edl}, which has a zero slope over the cell, and $\gamma_i=1/3$
produces a lumping-equivalent closure. 

\subsection{The Doubly-Discontinuous Trial Space}

Because of the temperature unknowns and the HO scattering source representation, a
representation on the interior of the cell for the temperature and intensity is needed.
Thus, we introduce a linear doubly discontinuous (LDD) trial space
for the half-range intensities, which is depicted in Fig.~\ref{fig:ldd_space}.  The linear
relation on the interior of the cell preserves the $L$ and $R$ moments of the solution,
and the outflow from the cell is some parametric (i.e., non linear) extrapolation of
those moments. 
The temperature is still represented with a linear interpolant of $T^4$ and $T$.  This
trial space has an extra unknown in the radiation equations for each cell and direction, which is eliminated
from the system with the HO spatial closure.  The ECMC algorithm is modified to also
include a LDD trial space which allows for estimate of the solution at faces, as discussed
later in Sec~\ref{sec:ldd_mc}. 

To solve the LO equations, Eq.~\eqref{eq:cl_slope} or~\eqref{eq:cl_avg} is substituted
locally for
the appropriate outflow face term in each LO moment equation. There is a spatial closure parameter for each
half-range, for each cell.
 The $\gamma_i^\pm$ are
estimated from the previous HO solution. For the initial LO solve within each
time step, the outflow is assumed continuous, using the standard upwinding and LD closure.  
As an example, the positive half-range and $L$ moment equation (i.e.,
Eq.~\eqref{eq:exact_lmomp}), for the scaled-slope closure, becomes
\begin{multline}
    -2{\mu}_{i-1/2}^{n+1,+} \left[\left(\frac{\ds 1 - 3 \gamma_{i-1}^{HO,+}}{\ds 2 }  \right)
        \mom{\phi}_{L,i-1}^+ + \left(\frac{\ds 1 + 3 \gamma_{i-1}^{HO,+}}{\ds 2 }  \right)
    \mom{\phi}_{R,i-1}^+
    \right] \\ + \cur {\mu}_{L,i}^{n+1,+}
  \mom{\phi}_{L,i}^{n+1,+}
  +  \cur\mu_{R,i}^{n+1,+}
  \mom{\phi}_{R,i}^{n+1,+}\\ +  \left(\sigma_{t,i}^{n+1}+\frac{1}{c \Delta t} \right) h_i 
  \mom{\phi}_{L,i}^{n+1,+} -  \frac{\sigma_{s,i} h_i}{2} \left( \mom{\phi}_{L,i}^{n+1,+} +
  \mom\phi_{L,i}^{n+1,-}\right)\\  = \frac{h_i}{2} \mom{\sigma_a^{n+1} a c T^{n+1,4}}_{L,i} +
  \frac{h_i}{c\Delta t}\mom{\phi}_{L,i}^{n,+},
    \label{eqn:clsd_posl}
\end{multline}
and the $R$ moment equation becomes
\begin{multline}
    2{\mu}_{i+1/2}^{n+1,+} \left[
    \left(\frac{\ds 1 - 3 \gamma_{i}^{HO,+}}{\ds 2 }  \right)
        \mom{\phi}_{L,i}^+ + \left(\frac{\ds 1 + 3 \gamma_{i}^{HO,+}}{\ds 2 }  \right)
    \mom{\phi}_{R,i}^+
    \right]  \\ 
    - \cur {\mu}_{L,i}^{n+1,+}
  \mom{\phi}_{L,i}^{n+1,+}
  -  \cur\mu_{R,i}^{n+1,+}
  \mom{\phi}_{R,i}^{n+1,+} +  \left(\sigma_{t,i}^{n+1}+\frac{1}{c \Delta t} \right) h_i 
  \mom{\phi}_{R,i}^{n+1,+} \\-  \frac{\sigma_{s,i} h_i}{2} \left( \mom{\phi}_{R,i}^{n+1,+} +
  \mom\phi_{R,i}^{n+1,-}\right) = \frac{h_i}{2} \mom{\sigma_a^{n+1} a c T^{n+1,4}}_{R,i} +
  \frac{h_i}{c\Delta t}\mom{\phi}_{R,i}^{n,+}.
    \label{eqn:clsd_posr}
\end{multline}
These equations contain only the original desired radiation moment and LD temperature unknowns.
During the Newton solve, once new half-range
intensities are determined, the temperatures are updated using the same material
energy equations as for the LD closure, i.e., Eq.~\eqref{eq:lo_mat_dis1} and Eq.~\eqref{eq:lo_mat_dis2}.

Because the
outflow from one cell is upwinded into the next cell, energy conservation by the LO
equations is preserved.
The closed equations have the
same numerical complexity as the LDFE LO equations, but with an increased storage on the
coarse mesh for the
$\{\gamma_i\}$.  Also, the linear representation for the interior
solutions and emission source should approach the LD closure in the equilibrium diffusion limit, as long
as the HO spatial closure is estimated with sufficient statistical accuracy.  


\subsection{Fixup for the Linear Doubly-Discontinuous Trial Space}

REWRITE: Combine next two paragraphs
The doubly discontinuous trial space presents an additional difficulty in that the outflow
is now unhinged from the linear relationship.  For this case, we use the lumped
representation on the interior of the solution for all cells. The outflow can still be driven negative
due to non-linearities, which leads to negative values in down-stream cells. 
This is a result of the HO estimation of the spatial closure using
and the moments was based on lagged source terms.  When negativities occur, we force the
outflow to be continous, using the lumping-equivalent LD closure in those cells.  That
Newton iteration must then be repeated.

In the case of strong gradients, the interior representation could be driven
negative.  In such cases, we can use the lumping-equivalent relation from
App.~\ref{app:lo_mom_relations} to define the linear representation.  For
example, the lumped emission source is
\begin{equation}
    T = \mom{T}_{L,i}^4 b_{L,i}(x) + \mom{T}_{R,i}^4 b_{R,i}(x) , \quad x\in(\xl,\xr)
\end{equation}
There are analogous relations for $T(x)$ and $\phi^\pm(x)$ over each cell.
These expressions are positive as long as the moments are positive, which is true for
physical solutions.  If the lagged, MC spatial closure produces an outflow from a cell that is
negative, then these moments could become negative.  In such cases, we force that cell to
use a standard lumped relation for the moment equations, with no discontinuity at the
outflow, and restart that Newton solve.  It is important to note that the spatial closure will still have the same
relation between the moments and the outflow; the lumping relation only affects the
linear representation that the moments correspond to.  For example in
Eq.~\eqref{eq:lo_mat_dis1}, the lumped representation changes $2/3
T_{L,i} + 1/3 T_{R,i}$ to $T_{L,i}$, but no modification are made to the
absorption term $\sigma_{a,i}\mom{\phi}_{L,i}$.

%During the Newton solve, once new half-range
%intensities are determined, the temperatures are updated using the material energy
%moment equations, i.e., Eq.~\eqref{eq:lo_mat_dis1} and Eq.~\eqref{eq:lo_mat_dis2}. For the
%uulumped case, the radiation moments are the same.  he slope moment,
%e.g., $\psi_{x,i}^\pm$, does not strictly correspond to the slope in the typical since.
%We have modified it in the lumped relation.  This is the same as the lumped closure relation using
%$\gamma_i=1/3$, where we are preserving the average moment exactly, but only second order
%accurate in the slope.

\begin{figure}[H]
    \centering
    {\resizebox{0.5\textwidth}{!}{
        \begin{tikzpicture}[scale=0.62, every node/.style={transform shape}]
            \draw (1.0,4.0) node[fill,circle,inner sep=0pt,minimum
            size=4.2pt] {};
            \draw [->] (1.6,4.25) -- (2.4,4.25) node[anchor=west] {$\mu$};
            \draw (1.0,0.4) -- (1.0,0.6) node[below, pos=0.4] {$x_{i-1/2}$};
            \draw (5.90,0.4) -- (5.90,0.6) node[below, pos=0.4] {$x_{i+1/2}$};
            \node at (3.6,3.06) {$\phi^+(x)$};
            \draw [thick] (1.0,0.5) -- (5.9,0.5) node[anchor=north west] {};
            \filldraw[color=black, fill=white] (1,3.1250) circle (2.1pt);
            \draw (1.0,3.125) -- (5.90,2.120);
            \filldraw[color=cyan, fill=white] (5.9,2.120) circle (2.1pt);
            \draw (5.9,1.5) node[cyan,fill,circle,inner sep=0pt,minimum size=4.2pt] {};
        \end{tikzpicture}
    }}
    \caption{Linear doubly-discontinous representation for mean intensity in LO equations.     \label{fig:ldd_space}}
\end{figure}


\subsection{Issues with ECMC for Spatial Closure}
\label{sec:ecmc_issues}
There are several issues with ECMC that cause the LO moments to not exactly preserve
the HO moments, even for a linear problem.  With ECMC, global and, particularly, local
energy balance are generally not preserved.  For standard MC, there
are source biasing techniques (e.g., systematic
sampling) that exactly preserve the local zeroth moment of the
source and thus satisfy the local balance equations~\cite{shultis_mc,wollaber_review}). 
However, for our HOLO method, even with standard MC we have to reconstruct the bilnear moment
of $x$ and $\mu$, so the consistency terms lead to LO equations that do not exactly
preserve the first moment of the HO solution\footnote{It was verified that with
standard MC, systematic sampling, no analog sampling, and a closure that is only a
function of the zeroth moment, the LO solution exactly reproduces the HO moments, for
a linear problem}.  One final reason is that the analog treatment of absorption for
particles below the weight cutoff (e.g., see Sec.~\ref{sec:tallies}) results in
$\sigma_a \phi^{HO}_i$ and the amount of energy removed from a cell during MC
transport to not be equal; this is due to statistical noise in the path-length
estimators for $\phi^{HO}_i$.  However, ECMC will preserve balance to the order of
the iterative error and statistical noise, so the closure parameters will reproduce
the HO moments to the accuracy of the LO solution.  




