%Commands for this section
\newcommand{\dep}{\ensuremath{\delta\epsilon^{(m)}}}



\section{Face Tallies and correction near $\mu=0$}
\label{sec:face_tallies}

Face-averaged estimators of the angular error are required to compute the outflow for
estimating the spatial closure. The standard face-based
tallies~\cite{shultis_mc,favorite_faces} are used.  Tallies are weighted by
the appropriate basis functions to compute a linear FE projection in $\mu$ at each face.  The
tally score, for the angular-averaged error $\epsilon_{a,i}$ is defined as
\begin{equation}
    \hat \epsilon_{a,i\pm1/2,j} = \frac{1}{N} \sum_{m=1}^{N_{i\pm1/2,j}}
    \frac{w_m(x_{i\pm1/2},\mu)}{h_{\mu} |\mu|},
\end{equation}
where $N$ is the number of histories performed and $N_{i\pm1/2,j}$ is the number of histories
that crossed the surface $i\pm1/2$, in the $j$ angular element.   For the first
moment, the tally is
\begin{equation}\label{eq:face_mutally}
    \hat \epsilon_{\mu,i\pm1/2,j} = \frac{1}{N} \sum_{m=1}^{N_{i+1/2,j}} 
    6\left(\frac{\mu-\mu_j}{h_\mu}\right) \frac{w_m(x_{i\pm1/2},\mu)}{|\mu| h_{\mu}}.
\end{equation}
For positive and negative direction outflows are tallied
on the $x_{i+1/2}$ and $x_{i-1/2}$ faces, respectively. Particles are only tallied after leaving
a cell, and, as discussed in Section~\ref{sec:ldd_mc}, particles born on a surface do not contribute
to the tally of that surface.

Near $\mu=0$, particles can contribute large scores to the zeroth angular moment that lead to large and
unbounded variances~\cite{favorite_faces}.  To avoid large variances, we have applied the standard fixup~\cite{mcnp,favorite_faces}.  
For $|\mu|$ below some small value $\mu_{cut}$, 
particles contribute the expected score over the range $(0,|\mu_{cut}|)$, based on an
approximate, isotropic particle density. Thus, scores in this range have no variance.  Assuming
an isotropic particle density $I_0$, the average of
$1/\mu$, for positive $\mu$, is
\begin{equation}
    \overline{1/\mu} = \frac{\displaystyle \int_0^{\mu_{cut}}\frac{1}{\mu} I_0 \,\d
\mu}{\displaystyle \int_0^{\mu_{cut}} I_0\, \d \mu} =
    \frac{2}{\mu_{cut}}.
\end{equation}
For negative $\mu$, $\overline{1/\mu}=-2/\mu_{cut}$.
All particles in the range $(0,|\mu_{cut}|)$ contribute the expected score by evaluating
the tallies at $\pm\mu = \pm2/\mu_{cut}$.  It is noted that the first angular moment tallies are
well defined because there is no $\mu$ term in the tally. THIS ISNT REALLY TRUE NOW
BECAUSE THE FINITE ELEMENT FIRST MOMENT IS FINE. Additionally, assuming an isotropic intensity over the range helps to limit
the first moment near $\mu=0$, which the LD trial space
generally cannot resolve anyways, as discussed in ???.

\section{MC solution with LDD trial space}
\label{sec:ldd_mc}

The inclusion of the outflow discontinuity has a minimal effect on the treatment of the
residual source. The residual source and process of estimating moments of
the error on the interior of a space-angle cell is unchanged.  The process of estimating
the solution on the outgoing face requires tallying the solution when particles leave a
cell. The tallying process is discussed later in Section~\ref{sec:face_tallies}.  

Applying $L$ to the LDD trial space, as shown in Fig.~\ref{fig:ldd}, results in two $\delta$ functions at each interior face.
For positive flow, at a face $x_{i+1/2}$, the face portion of the residual is defined as
\begin{align}
    \label{eq:res_face}
    \rface(x_{i+1/2}) &= -\mu \pderiv{\tilde I^{(m)}}{x}\big|_{x_{i+1/2}}\\
    &= \rface(x_{i+1/2}^-)\delta^-(x - x_{i+1/2}) + \rface(x_{i+1/2}^+)\delta^+(x - x_{i+1/2}) 
\end{align}
where
\begin{align}
    \rface(x_{i+1/2}^-) &= -\mu\left( \tilde I^{(m)}(x_{i+1/2},\mu) - \tilde I^{(m)}(x_{i+1/2}^-,\mu)
           \right)\\
    \rface(x_{i+1/2}^+) &= -\mu\left( \tilde I^{(m)}(x_{i+1/2}^+,\mu) -
           \tilde I^{(m)}(x_{i+1/2},\mu)
           \right).
\end{align}
Here, $I^{(m)}(x_{i+1/2}^+)$ and $I^{(m)}(x_{i+1/2}^-)$ are the LD solution extrapolated to $x_{i+1/2}$ from the
$x$ cell $i$ and cell $i+1$, respectively.
Particles sampled from the two $\delta$-functions have the same starting location.  The
only difference is, for positive $\mu$,  particles sampled from $\rface(x^-_{i+1/2})$ will
contribute to the face tally at $x_{i+1/2}$; the opposite is true for negative $\mu$.

To reduce variance, we do not sample the two $\delta$ functions independently.
%or score contributions to the outflow face from the interior face source. 
Instead, we combine the
two $\delta$-functions into a single face source,
do not score particles at the face from which they are sampled.  To account for the
untallied error, we add the analytic
contribution to the error from the face source to the corresponding face at the end of a batch.
It is noted the combination of the two $\delta$-functions produces the same residual source as the
original LD residual.

Define the additional error contribution 
from the face sources at $x_{i+1/2}$ as $\dep$.  This additional error is tallied
everywhere by MC, except for at $x_{i+1/2}$.  The transport equation satisfied by $\dep$, for positive
$\mu$, with effective total cross 
section $\hat \sigma_t$, is
\begin{equation}
    \label{eq:ho_face}
    \mu \pderiv{\dep}{x} + \hat\sigma_t \dep = \rface(x_{i+1/2}^-)\delta^-(x - x_{i+1/2}) + \rface(x_{i+1/2}^+)\delta^+(x - x_{i+1/2}) 
\end{equation}
This equation is integrated from $x_{i+1/2}-\alpha$ to $x_{i+1/2}$ to produce
\begin{multline}
    \mu\dep(x_{i+1/2},\mu) - \mu\dep(x_{i+1/2}-\alpha,\mu)  + \int\limits_{x_{i+1/2}-\alpha}^0 
    \hat \sigma_t \dep \d x  \\ =  \rface(x_{i+1/2}^-) +
        \int\limits_{x_{i+1/2}-\alpha}^0\rface(x_{i+1/2}^+)\delta^+(x - x_{i+1/2}) \d x.
\end{multline}
The integral on the right side of the equation is zero because $\delta^+(x-x_{i+1/2})$ is
zero for $(-\infty,x_{i+1/2}]$.  The limit of the above equation is taken as $\alpha\to0$, i.e.,
\begin{multline}
    \lim_{\alpha\to0}\left( \mu\dep(x_{i+1/2},\mu) - \mu\dep(x_{i+1/2}-\alpha,\mu)  + \int\limits_{x_{i+1/2}-\alpha}^0 
    \hat \sigma_t \dep \d x \right)  = \lim_{\alpha\to0} \rface(x_{i+1/2}^-) 
\end{multline}
The integral goes to zero because $\dep$ is smooth on the interior of the cell, and
$\mu\dep(x_{i+1/2}-\alpha,\mu)$ goes to zero because there is no source upstream of
$x_{i+1/2}^-$. Thus, the final solution is
\begin{equation}
    \dep(x_{i+1/2},\mu) = \frac{\rface(x_{i+1/2}^-)}{\mu} = 
     \tilde I^{(m)}(x_{i+1/2}^-,\mu) - \tilde I^{(m)}(x_{i+1/2},\mu)
.
\end{equation}
The update for $I(x_{i+1/2},\mu)$ is 
\begin{align}
   \tilde I^{(m+1)}(x_{i+1/2},\mu) &= \tilde I^{(m)}(x_{i+1/2},\mu) + \epsilon^{(m)}(x_{i+1/2},\mu) +
    \dep(x_{i+1/2},\mu) \\ 
        &= \tilde I^{(m)}(x_{i+1/2}^-,\mu) + \epsilon^{(m)}(x_{i+1/2},\mu).
\end{align}
This result has the peculiar effect that the estimation of the solution on a face depends only on
the interior solution $\tilde I^{(m)}(x_{i+1/2}^-,\mu)$ and not the previous face value 
$\tilde I^{(m)}(x_{i+1/2},\mu)$. This could be used to only estimate
face values in particular cells, at any chosen batch.



\section{Implementation of ECMC finite-element space, tallies, and residual sampling}

\label{app:tallies}

The ECMC solver uses a finite element representation in space and angle. On the
interior of the cell with the $i$-th spatial index and $j$-th angular index, the linear representation is defined as
\begin{equation*}
    \tilde I(x,\mu) = I_{a,ij} + \frac{2}{h_x}I_{x,ij}\left(x-x_i\right) +
    \frac{2}{h_\mu}I_{\mu,ij}\left(\mu-\mu_j\right), \quad x_\il <  x < x_\ir,\quad
     \mu_\jl \leq \mu \leq \mu_\jr
\end{equation*}
The spatial cell width is $h_x$, the angular width is
$h_\mu$, the center of the cell is $(x_i,\mu_j)$, and
\begin{align}\label{app1}
    I_{a,ij} &= \frac{1}{h_x h_\mu} \iint\limits_{\mathcal{D}} I(x,\mu)\, \d x \d \mu \\
    I_{x,ij} &= \frac{6}{h_xh_\mu}\iint\limits_{\mathcal{D}} \left(\frac{x - x_i}{h_{x}}\right)
    I(x,\mu)\, \d x \d \mu \\ \label{app2}
    I_{\mu,ij} &= \frac{6}{h_xh_\mu}\iint\limits_{\mathcal{D}}
     \left(\frac{\mu - \mu_j}{h_{\mu}}\right)
    I(x,\mu)\, \d x \d \mu,
\end{align}
where $\mathcal{D}: x_\il \leq  x \leq  x_\ir \times \mu_\jl \leq \mu \leq \mu_\jr$.
%$I_a$ is the cell average intensity, and $I_\mu$ and $I_x$ define the
%the first moment in $\mu$ and $x$ of the intensity, respectively. 
Standard upwinding in space is used to
define $I(\mu)$ on incoming faces. 

This representation can directly be plugged into
Eq.~\eqref{eq:resid} and evaluated to produce the residual source in the ECMC HO transport
problem.  The MC source $r^{(m)}(x,\mu)$ in Eq.~\eqref{eq:mc_err}
consists of both face and volumetric sources and can produce positive and
negative weight particles.  The distribution for sampling particle coordinates, in space and angle, is based on the $L_1$
norm over space and angle of the residual~\cite{jake}.  A particular cell volume or face 
is sampled, and then rejection sampling~\cite{shultis_mc} is used to sample from
the appropriate distribution on the face or interior of the space-angle cell.  If the
residual is negative at the sampled coordinates, the weight of the particle history is negative.

During a MC batch, moments of the error are tallied.  The necessary moments of the error are
defined analogously to Eq.'s~\eqref{app1}--\eqref{app2}.
The tallies are evaluated by weighting the particle density with the appropriate
basis function and integrating along the history path through the cell.  For the cell average, the $n$-th
particle makes the contribution
\begin{equation}
    \epsilon^n_{a,ij} = \frac{1}{h_xh_\mu} \int\limits_{s^n_o}^{s^n_f}  w^n(x,\mu) \d s,
\end{equation}
where $s_o^n$ and $s_f^n$ are the beginning and end of the $n$-th particle track in the cell and $w(x,\mu)$ is
the weight of the error particle in the MC simulation.  Weight is attenuated exponentially, i.e., $w(x,\mu)\propto
\exp(-\sigma_t|x/\mu|)$.
Substitution of the exponential attenuation of the weight produces the result
\begin{equation}
    \epsilon^n_{a,ij} = \frac{w(x_0,\mu)}{\sigma_t h_x h_\mu} \left(1 -
    e^{-\sigma_ts^n}\right).
\end{equation}
Here, $w(x_0,\mu)$ is the particle weight at the start of the path and $s^n$ is the
length of the track. The contribution of a
particle track to $\epsilon_x$ is given by
\begin{equation}
    \epsilon^n_{x,ij} = \frac{w(x_0,\mu)}{h_x^2h_\mu \sigma_t} \left[x_0 - x_f e^{-\sigma_t s^n}
        + \left(\frac{\mu}{\sigma_t} - x_i \right)\left(1-e^{-\sigma_t s^n}\right),
    \right]
\end{equation}
where $x_0$ and $x_f$ are the beginning and ending $x$ coordinates of the $n$-th
path.  The contribution to the first moment in $\mu$ is 
\begin{equation}
    \epsilon^n_{\mu,ij} = \frac{w(x_0,\mu)}{h_{\mu}^2h_x\sigma_t}\left(\mu -
    \mu_j\right) \left(1 - e^{-\sigma_ts^n}\right),
\end{equation}
where the particle $x$-direction cosine $\mu$ does not change because it is a pure-absorber simulation.
Finally, the moments of the error are simply the average contribution of all particles.

\section{Adaptive Mesh Refinement}
\label{app:refinement}
This section describes the adaptive refinement strategy for the ECMC algorithm.
Detailed equations for performing projections between meshes and computing the residual source on
the refined meshes can be found in~\cite{jake}.  At the end of the ECMC batch,
refinement is performed in space-angle cells based on a jump indicator.  The jump
indicator is the magnitude of the different between $I(x,\mu)$ in adjacent cells,
averaged over each edge.  The value of the largest jump, out of the four edges within a
cell, is used as the
indicator for that cell.  Based on this indicator, the 20\% of cells with the largest jump are
refined.  Future work will explore simply using $\epsilon$ to indicate refinement,
rather than the jump error.  The refinement of a cell is chosen to be symmetric, with each space-angle cell divided into four
equal-sized cells.  The solution for $\tilde{I}^{n+1}(x,\mu)$ of the batch is projected onto
the finer mesh for the next batch. Because the dimensionality of the sample space has
increased, we increase the number of histories per batch s.t. the ratio of the number
of histories to total cells is approximately constant for all meshes.  At the end of the last HO solve in a time step,
$\tilde{I}^{n+1}$ is projected back onto the original, coarsest mesh and stored as
$\tilde{I}^{n}$ for the next time step.
